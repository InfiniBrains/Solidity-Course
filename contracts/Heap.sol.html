<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Heap.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Heap.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/43</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/44</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
&nbsp;
pragma solidity ^0.8.9;
&nbsp;
// Eth Heap
// Authors: Alexandre Tolstenko
// Original Author: Zac Mitton
// License: MIT
// ref.: https://github.com/zmitton/eth-heap/blob/master/contracts/Heap.sol
// ref.: https://github.com/zmitton/eth-heap/blob/master/contracts/OrderBookHeap.sol
&nbsp;
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
&nbsp;
// todo: get node by timestamp
// todo: remove nodes older than a provided time
&nbsp;
library Heap { // default max-heap
  using SafeMath for uint256;
&nbsp;
  uint256 constant ROOT_INDEX = 1;
&nbsp;
  struct Data{
    uint256 idCount;
    Node[] nodes; // root is index 1; index 0 not used
    mapping (uint256 =&gt; uint256) indices; // unique id =&gt; node index
    mapping (uint256 =&gt; uint256) timeByIndices; //unique time =&gt; node index
  }
  struct Node{
    uint256 id;
    uint256 price;
    uint256 time;
  }
&nbsp;
  //call init before anything else
<span class="fstat-no" title="function not covered" >  function init(Data storage self) internal{</span>
<span class="cstat-no" title="statement not covered" >    if(self.nodes.length == 0) <span class="cstat-no" title="statement not covered" >self.nodes.push(Node(0,0,0))</span>;</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function insert(Data storage self, uint256 price, uint256 time) internal returns(Node memory){//√</span>
<span class="cstat-no" title="statement not covered" >    if(self.nodes.length == 0){ <span class="cstat-no" title="statement not covered" >init(self)</span>; }</span>// test on-the-fly-init
<span class="cstat-no" title="statement not covered" >    self.idCount.add(1)</span>;
//    self.nodes.length++; // old approach
<span class="cstat-no" title="statement not covered" >    self.nodes.push(Node(0,0,0))</span>;
<span class="cstat-no" title="statement not covered" >    Node memory n = Node(self.idCount, price, time);</span>
<span class="cstat-no" title="statement not covered" >    _bubbleUp(self, n, self.nodes.length-1)</span>;
<span class="cstat-no" title="statement not covered" >    return n;</span>
  }
<span class="fstat-no" title="function not covered" >  function extractMax(Data storage self) internal returns(Node memory){//√</span>
<span class="cstat-no" title="statement not covered" >    return _extract(self, ROOT_INDEX);</span>
  }
<span class="fstat-no" title="function not covered" >  function extractById(Data storage self, uint256 id) internal returns(Node memory){//√</span>
<span class="cstat-no" title="statement not covered" >    return _extract(self, self.indices[id]);</span>
  }
&nbsp;
  //view
<span class="fstat-no" title="function not covered" >  function dump(Data storage self) internal view returns(Node[] memory){</span>
    //note: Empty set will return `[Node(0,0,0,0)]`. uninitialized will return `[]`.
<span class="cstat-no" title="statement not covered" >    return self.nodes;</span>
  }
<span class="fstat-no" title="function not covered" >  function getById(Data storage self, uint256 id) internal view returns(Node storage){</span>
<span class="cstat-no" title="statement not covered" >    return getByIndex(self, self.indices[id]);</span>//test that all these return the emptyNode
  }
<span class="fstat-no" title="function not covered" >  function getByIndex(Data storage self, uint256 i) internal view returns(Node storage) {</span>
<span class="cstat-no" title="statement not covered" >    require(self.nodes.length &gt; i, "index not found")</span>;
    // return self.nodes.length &gt; i ? self.nodes[i] : Node(0,0,0,0); // old approach
<span class="cstat-no" title="statement not covered" >    return self.nodes[i];</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function getByTime(Data storage self, uint256 time) internal view returns(Node storage){</span>
<span class="cstat-no" title="statement not covered" >    require(self.timeByIndices[time] != 0, "index not found")</span>;
<span class="cstat-no" title="statement not covered" >    return self.nodes[self.timeByIndices[time]];</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function getMax(Data storage self) internal view returns(Node storage){</span>
<span class="cstat-no" title="statement not covered" >    return getByIndex(self, ROOT_INDEX);</span>
  }
<span class="fstat-no" title="function not covered" >  function size(Data storage self) internal view returns(uint256){</span>
<span class="cstat-no" title="statement not covered" >    return self.nodes.length &gt; 0 ? self.nodes.length-1 : 0;</span> // todo: is it really possible to be negative???
  }
<span class="fstat-no" title="function not covered" >  function isNode(Node memory n) internal pure returns(bool){ <span class="cstat-no" title="statement not covered" >return n.id &gt; 0;</span> }</span>
&nbsp;
  //private
<span class="fstat-no" title="function not covered" >  function _extract(Data storage self, uint256 i) private returns(Node memory){//√</span>
<span class="cstat-no" title="statement not covered" >    if(self.nodes.length &lt;= i || i &lt;= 0){ <span class="cstat-no" title="statement not covered" >return Node(0,0,0);</span> }</span>  // todo: modifier add timesByIndeces
&nbsp;
<span class="cstat-no" title="statement not covered" >    Node memory extractedNode = self.nodes[i];</span>
    delete self.indices[extractedNode.id];
&nbsp;
<span class="cstat-no" title="statement not covered" >    Node memory tailNode = self.nodes[self.nodes.length-1];</span>
    // self.nodes.length--; // old approach
<span class="cstat-no" title="statement not covered" >    self.nodes.pop()</span>; // updated approach todo: check this
&nbsp;
<span class="cstat-no" title="statement not covered" >    if(i &lt; self.nodes.length){ // if extracted node was not tail</span>
<span class="cstat-no" title="statement not covered" >      _bubbleUp(self, tailNode, i)</span>;
<span class="cstat-no" title="statement not covered" >      _bubbleDown(self, self.nodes[i], i)</span>; // then try bubbling down
    }
<span class="cstat-no" title="statement not covered" >    return extractedNode;</span>
  }
<span class="fstat-no" title="function not covered" >  function _bubbleUp(Data storage self, Node memory n, uint256 i) private{//√</span>
<span class="cstat-no" title="statement not covered" >    if(i==ROOT_INDEX || n.price &lt;= self.nodes[i/2].price){</span>
<span class="cstat-no" title="statement not covered" >      _insert(self, n, i)</span>;
    }else{
<span class="cstat-no" title="statement not covered" >      _insert(self, self.nodes[i/2], i)</span>;
<span class="cstat-no" title="statement not covered" >      _bubbleUp(self, n, i/2)</span>;
    }
  }
<span class="fstat-no" title="function not covered" >  function _bubbleDown(Data storage self, Node memory n, uint256 i) private{//</span>
<span class="cstat-no" title="statement not covered" >    uint256 length = self.nodes.length;</span>
<span class="cstat-no" title="statement not covered" >    uint256 cIndex = i*2;</span> // left child index
&nbsp;
<span class="cstat-no" title="statement not covered" >    if(length &lt;= cIndex){</span>
<span class="cstat-no" title="statement not covered" >      _insert(self, n, i)</span>;
    }else{
<span class="cstat-no" title="statement not covered" >      Node memory largestChild = self.nodes[cIndex];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      if(length &gt; cIndex+1 &amp;&amp; self.nodes[cIndex+1].price &gt; largestChild.price ){</span>
        largestChild = self.nodes[++cIndex];
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      if(largestChild.price &lt;= n.price){</span>
<span class="cstat-no" title="statement not covered" >        _insert(self, n, i)</span>;
      }else{
<span class="cstat-no" title="statement not covered" >        _insert(self, largestChild, i)</span>;
<span class="cstat-no" title="statement not covered" >        _bubbleDown(self, n, cIndex)</span>;
      }
    }
  }
&nbsp;
&nbsp;
  // todo: check all functions using id
<span class="fstat-no" title="function not covered" >  function _insert(Data storage self, Node memory n, uint256 i) private{//√</span>
    self.nodes[i] = n;
    self.indices[n.id] = i;
    self.timeByIndices[n.time] = i; //todo: check is real
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 31 2023 22:21:47 GMT+0000 (Coordinated Universal Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
